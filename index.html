<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPSP Berriane - Portail des Formations</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajwal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Tajwal', 'sans-serif'],
                    },
                    colors: {
                        brand: { 50: '#f0fdf4', 100: '#dcfce7', 500: '#22c55e', 600: '#16a34a', 700: '#15803d', 900: '#14532d' }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Tajwal', sans-serif; background-color: #f8fafc; }
        .hidden { display: none !important; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="min-h-screen flex flex-col text-gray-800">

    <nav class="glass shadow-sm sticky top-0 z-40 border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="bg-brand-100 p-2 rounded-lg mr-3">
                        <svg class="h-6 w-6 text-brand-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 21l9-5-9-5-9 5 9 5z" />
                        </svg>
                    </div>
                    <div>
                        <span class="font-bold text-xl text-gray-900 block leading-none">EPSP Berriane</span>
                        <span class="text-xs text-brand-600 font-medium uppercase tracking-wider">Portail des Formations</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <button onclick="promptAdminLogin()" id="admin-toggle-btn" class="text-sm font-medium text-gray-500 hover:text-brand-600 hover:bg-brand-50 px-4 py-2 rounded-lg transition-colors">
                        Accès Admin
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        
        <div id="user-view" class="space-y-8">
            <div class="text-center max-w-2xl mx-auto mb-12">
                <h1 class="text-4xl font-extrabold text-gray-900 mb-4 tracking-tight">Développez vos compétences</h1>
                <p class="text-lg text-gray-500">Inscrivez-vous aux prochaines sessions de formation organisées par notre établissement.</p>
            </div>
            
            <div id="formations-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div class="col-span-full flex justify-center py-12">
                    <div class="animate-pulse flex flex-col items-center">
                        <div class="h-12 w-12 bg-brand-200 rounded-full mb-4"></div>
                        <p class="text-brand-600 font-medium">Chargement des formations...</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="admin-view" class="hidden animate-fade-in">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Tableau de bord</h1>
                    <p class="text-gray-500 mt-1">Gestion des formations et des inscriptions</p>
                </div>
                <button onclick="openAdminModal()" class="bg-brand-600 hover:bg-brand-700 text-white px-5 py-2.5 rounded-lg font-semibold shadow-lg shadow-brand-500/30 transition-all flex items-center">
                    <span class="text-xl mr-2 leading-none">+</span> Nouvelle Formation
                </button>
            </div>
            
            <div class="bg-white shadow-sm border border-gray-200 rounded-xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Formation</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Date & Lieu</th>
                                <th class="px-6 py-4 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Inscriptions</th>
                            </tr>
                        </thead>
                        <tbody id="admin-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <footer class="bg-white border-t border-gray-200 mt-auto">
        <div class="max-w-7xl mx-auto px-4 py-8 flex flex-col md:flex-row justify-between items-center gap-4">
            <p class="text-gray-500 text-sm font-medium">© 2026 EPSP Berriane. Tous droits réservés.</p>
            <div class="flex items-center text-sm">
                <span class="text-gray-400 mr-2"> - </span>
                <span class="font-bold text-brand-600 bg-brand-50 px-3 py-1 rounded-full">dev. Ing. Ferhat Hamza</span>
            </div>
        </div>
    </footer>

    <div id="login-modal" class="fixed inset-0 z-[60] hidden bg-gray-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all">
            <div class="p-6 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-brand-100 mb-4">
                    <svg class="h-6 w-6 text-brand-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Authentification</h3>
                <p class="text-sm text-gray-500 mb-6">Veuillez entrer le mot de passe administrateur.</p>
                <input type="password" id="admin-password" class="w-full text-center border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none mb-4" placeholder="••••••••">
                <div class="flex gap-3">
                    <button onclick="closeModal('login-modal')" class="flex-1 bg-gray-100 text-gray-700 font-bold rounded-xl px-4 py-3 hover:bg-gray-200 transition">Annuler</button>
                    <button onclick="verifyAdmin()" class="flex-1 bg-brand-600 text-white font-bold rounded-xl px-4 py-3 hover:bg-brand-700 transition shadow-lg shadow-brand-500/30">Valider</button>
                </div>
            </div>
        </div>
    </div>

    <div id="inscription-modal" class="fixed inset-0 z-50 hidden bg-gray-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="px-6 py-5 border-b border-gray-100 flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-900">Formulaire d'inscription</h3>
                <button onclick="closeModal('inscription-modal')" class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full p-1 transition"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
            </div>
            <form id="inscription-form" onsubmit="submitInscription(event)" class="p-6 space-y-5">
                <input type="hidden" id="ins-formation-id">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Nom</label>
                        <input type="text" id="ins-nom" required class="w-full border border-gray-300 rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Prénom</label>
                        <input type="text" id="ins-prenom" required class="w-full border border-gray-300 rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Service</label>
                    <select id="ins-service" required class="w-full border border-gray-300 rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none">
                        <option value="">Sélectionnez un service</option>
                        <option value="Direction">Direction</option>
                        <option value="Ressources Humaines">Ressources Humaines</option>
                        <option value="Informatique">Informatique</option>
                        <option value="Médical">Médical</option>
                        <option value="Technique">Technique</option>
                        <option value="Commercial">Commercial</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Grade</label>
                    <select id="ins-grade" required class="w-full border border-gray-300 rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none">
                        <option value="">Sélectionnez un grade</option>
                        <option value="Employé">Employé</option>
                        <option value="Technicien">Technicien</option>
                        <option value="Ingénieur">Ingénieur</option>
                        <option value="Médecin">Médecin</option>
                        <option value="Cadre Supérieur">Cadre Supérieur</option>
                    </select>
                </div>
                <div class="pt-4">
                    <button type="submit" class="w-full bg-brand-600 text-white font-bold rounded-xl px-4 py-3.5 hover:bg-brand-700 transition shadow-lg shadow-brand-500/30">Confirmer ma présence</button>
                </div>
            </form>
        </div>
    </div>

    <div id="admin-modal" class="fixed inset-0 z-50 hidden bg-gray-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl overflow-hidden max-h-[90vh] flex flex-col">
            <div class="px-6 py-5 border-b border-gray-100 flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-900">Créer une nouvelle formation</h3>
                <button onclick="closeModal('admin-modal')" class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full p-1 transition"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
            </div>
            <div class="overflow-y-auto p-6 bg-gray-50/50">
                <form id="admin-form" onsubmit="submitFormation(event)" class="space-y-5">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Titre (Français)</label>
                            <input type="text" id="add-name-fr" required class="w-full border border-gray-300 rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-brand-500 outline-none">
                        </div>
                        <div dir="rtl">
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Titre (Arabe) - العنوان</label>
                            <input type="text" id="add-name-ar" required class="w-full border border-gray-300 rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-brand-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Nom du Formateur</label>
                            <input type="text" id="add-formateur" required class="w-full border border-gray-300 rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-brand-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Lieu</label>
                            <input type="text" id="add-location" required class="w-full border border-gray-300 rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-brand-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Date</label>
                            <input type="date" id="add-date" required class="w-full border border-gray-300 rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-brand-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Heure</label>
                            <input type="time" id="add-time" required class="w-full border border-gray-300 rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-brand-500 outline-none">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Affiche / Photo (Max: 4MB)</label>
                        <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-xl bg-white hover:bg-gray-50 transition">
                            <div class="space-y-1 text-center">
                                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                                <div class="flex text-sm text-gray-600 justify-center">
                                    <label class="relative cursor-pointer bg-white rounded-md font-medium text-brand-600 hover:text-brand-500 focus-within:outline-none">
                                        <span>Télécharger un fichier</span>
                                        <input id="add-image" type="file" accept="image/*" required class="sr-only">
                                    </label>
                                </div>
                                <p class="text-xs text-gray-500" id="file-name-display">PNG, JPG, GIF jusqu'à 4MB</p>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Description</label>
                        <textarea id="add-desc" rows="3" required class="w-full border border-gray-300 rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-brand-500 outline-none"></textarea>
                    </div>
                    <div class="pt-4">
                        <button type="submit" id="submit-formation-btn" class="w-full bg-gray-900 text-white font-bold rounded-xl px-4 py-3.5 hover:bg-gray-800 transition shadow-lg">Publier la formation</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // === CONFIGURATION API ===
        const API_URL = 'https://epspformation-api.didcrist.workers.dev';
        
        let formationsList = [];
        let isAdmin = false;
        let base64ProcessedImage = "";

        // Initialisation
        document.addEventListener('DOMContentLoaded', fetchFormations);

        // --- AUTHENTICATION ADMIN ---
        function promptAdminLogin() {
            if (isAdmin) {
                toggleAdmin(false); // Logout
            } else {
                document.getElementById('admin-password').value = '';
                openModal('login-modal');
                setTimeout(() => document.getElementById('admin-password').focus(), 100);
            }
        }

        async function verifyAdmin() {
            const passInput = document.getElementById('admin-password');
            const pass = passInput.value;
            const btn = document.querySelector('#login-modal button.bg-brand-600');
            
            const originalText = btn.textContent;
            btn.textContent = "Vérification...";
            btn.disabled = true;

            try {
                const response = await fetch(`${API_URL}/api/auth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: pass })
                });

                if (response.ok) {
                    closeModal('login-modal');
                    toggleAdmin(true);
                    passInput.value = ''; // On vide le champ par sécurité
                } else {
                    alert("Mot de passe incorrect.");
                }
            } catch (err) {
                alert("Erreur de connexion au serveur.");
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function toggleAdmin(state) {
            isAdmin = state;
            document.getElementById('user-view').classList.toggle('hidden', isAdmin);
            document.getElementById('admin-view').classList.toggle('hidden', !isAdmin);
            
            const btn = document.getElementById('admin-toggle-btn');
            if(isAdmin) {
                btn.textContent = "Quitter Mode Admin";
                btn.classList.add('bg-red-50', 'text-red-600');
            } else {
                btn.textContent = "Accès Admin";
                btn.classList.remove('bg-red-50', 'text-red-600');
            }
        }

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function openAdminModal() { openModal('admin-modal'); base64ProcessedImage = ""; document.getElementById('file-name-display').textContent = "PNG, JPG, GIF jusqu'à 4MB"; }

        function openInscriptionModal(formationId) {
            document.getElementById('ins-formation-id').value = formationId;
            openModal('inscription-modal');
        }

        // --- GESTION DE L'IMAGE (< 4MB) ---
        document.getElementById('add-image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const display = document.getElementById('file-name-display');
            
            if (!file) {
                display.textContent = "PNG, JPG, GIF jusqu'à 4MB";
                return;
            }
            
            // Limite stricte de 4MB
            if (file.size > 4 * 1024 * 1024) {
                alert("Fichier trop volumineux. La taille maximum est de 4MB.");
                this.value = '';
                display.textContent = "Fichier rejeté (Trop lourd)";
                display.classList.add('text-red-500');
                return;
            }

            display.textContent = "Traitement en cours...";
            display.classList.remove('text-red-500');

            // Compression de l'image pour l'adapter à la base de données D1 (Max 1MB par ligne)
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 1000;
                    const MAX_HEIGHT = 1000;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                    } else {
                        if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Compression en JPEG qualité 70% pour garantir une petite taille
                    base64ProcessedImage = canvas.toDataURL('image/jpeg', 0.7);
                    display.textContent = `Image prête : ${file.name}`;
                    display.classList.add('text-brand-600');
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(file);
        });

        // --- API CALLS ---

        async function fetchFormations() {
            try {
                // FIXED: added /api/ to match worker configuration
                const res = await fetch(`${API_URL}/api/formations`);
                formationsList = await res.json();
                renderUserView();
                renderAdminView();
            } catch (err) {
                console.error("Erreur de chargement", err);
                document.getElementById('formations-grid').innerHTML = '<div class="col-span-full text-center py-10"><p class="text-red-500 font-bold bg-red-50 p-4 rounded-xl inline-block border border-red-200">Impossible de joindre le serveur. Vérifiez votre connexion.</p></div>';
            }
        }

        async function submitInscription(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.textContent;
            btn.textContent = "Envoi en cours...";
            btn.disabled = true;

            const payload = {
                formation_id: document.getElementById('ins-formation-id').value,
                nom: document.getElementById('ins-nom').value,
                prenom: document.getElementById('ins-prenom').value,
                service: document.getElementById('ins-service').value,
                grade: document.getElementById('ins-grade').value
            };

            try {
                // FIXED: added /api/ to match worker configuration
                await fetch(`${API_URL}/api/inscriptions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                alert('Votre inscription a été enregistrée avec succès !');
                closeModal('inscription-modal');
                e.target.reset();
            } catch (err) {
                alert('Erreur lors de l\'inscription. Veuillez réessayer.');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        async function submitFormation(e) {
            e.preventDefault();
            if (!base64ProcessedImage) {
                alert("Veuillez patienter pendant le traitement de l'image ou sélectionner une image valide.");
                return;
            }

            const btn = document.getElementById('submit-formation-btn');
            btn.textContent = "Publication...";
            btn.disabled = true;

            const payload = {
                name_fr: document.getElementById('add-name-fr').value,
                name_ar: document.getElementById('add-name-ar').value,
                formateur: document.getElementById('add-formateur').value,
                location: document.getElementById('add-location').value,
                date: document.getElementById('add-date').value,
                time: document.getElementById('add-time').value,
                description: document.getElementById('add-desc').value,
                image_url: base64ProcessedImage // Envoi de l'image compressée
            };

            try {
                // FIXED: added /api/ to match worker configuration
                const response = await fetch(`${API_URL}/api/formations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if(response.ok) {
                    alert('Formation publiée avec succès !');
                    closeModal('admin-modal');
                    e.target.reset();
                    document.getElementById('file-name-display').textContent = "PNG, JPG, GIF jusqu'à 4MB";
                    base64ProcessedImage = "";
                    fetchFormations();
                } else {
                    throw new Error("Erreur serveur");
                }
            } catch (err) {
                alert("Une erreur est survenue. L'image est peut-être trop lourde pour la base de données.");
            } finally {
                btn.textContent = "Publier la formation";
                btn.disabled = false;
            }
        }

        async function exportInscriptions(formationId, formationName) {
            try {
                // FIXED: added /api/ to match worker configuration
                const res = await fetch(`${API_URL}/api/inscriptions?formation_id=${formationId}`);
                const data = await res.json();
                
                if (data.length === 0) {
                    alert("Aucun inscrit pour cette formation pour le moment.");
                    return;
                }

                const headers = ['ID', 'Nom', 'Prenom', 'Service', 'Grade', 'Date inscription'];
                const csvRows = [headers.join(',')];
                
                data.forEach(row => {
                    csvRows.push([row.id, row.nom, row.prenom, row.service, row.grade, row.created_at].join(','));
                });

                const csvString = csvRows.join('\n');
                const blob = new Blob(["\uFEFF"+csvString], { type: 'text/csv;charset=utf-8;' }); // \uFEFF for Excel UTF-8
                const url = window.URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.setAttribute('hidden', '');
                a.setAttribute('href', url);
                a.setAttribute('download', `Inscrits_${formationName.replace(/\s+/g, '_')}.csv`);
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } catch (err) {
                alert("Erreur lors de l'exportation.");
            }
        }

        // --- RENDERING ---

        function renderUserView() {
            const grid = document.getElementById('formations-grid');
            if (formationsList.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center py-16 bg-white rounded-2xl border border-dashed border-gray-300">
                        <svg class="h-16 w-16 text-gray-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                        <p class="text-gray-500 font-medium text-lg">Aucune formation programmée pour le moment.</p>
                    </div>`;
                return;
            }

            grid.innerHTML = formationsList.map(f => `
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-xl transition-shadow duration-300 flex flex-col h-full group">
                    <div class="relative h-56 overflow-hidden bg-gray-100">
                        <img src="${f.image_url}" alt="Affiche" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
                        <div class="absolute top-4 right-4 bg-white/90 backdrop-blur text-gray-900 text-xs font-bold px-3 py-1 rounded-full shadow-sm">
                            ${f.date}
                        </div>
                    </div>
                    <div class="p-6 flex-grow flex flex-col">
                        <div class="flex flex-col items-start mb-3 gap-2">
                            <h2 class="text-xl font-bold text-gray-900 leading-tight">${f.name_fr}</h2>
                            <span class="text-lg font-bold text-brand-700 font-arabic whitespace-nowrap" dir="rtl">${f.name_ar}</span>
                        </div>
                        <p class="text-sm text-gray-500 mb-6 line-clamp-3 flex-grow">${f.description}</p>
                        
                        <div class="flex items-center">
                            <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg> 
                            <span class="font-semibold w-20">Formateur:</span> 
                            <span class="truncate">${f.formateur}</span>
                        </div>
                    
                        <div class="flex items-center">
                            <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg> 
                            <span class="font-semibold w-20">Lieu:</span> 
                            <span class="truncate">${f.location}</span>
                        </div>
                    
                        <div class="flex items-center">
                            <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg> 
                            <span class="font-semibold w-20">Date:</span> 
                            <span>${f.date}</span>
                        </div>
                    
                        <div class="flex items-center">
                            <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg> 
                            <span class="font-semibold w-20">Heure:</span> 
                            <span>${f.time}</span>
                        </div>
                    </div>

                        <button onclick="openInscriptionModal(${f.id})" class="w-full text-center bg-brand-50 text-brand-600 hover:bg-brand-600 hover:text-white font-bold py-3 px-4 rounded-xl transition-all duration-300">
                            S'inscrire à la session
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderAdminView() {
            const tbody = document.getElementById('admin-table-body');
            if (formationsList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="px-6 py-8 text-center text-gray-500">Aucune formation créée.</td></tr>';
                return;
            }
            
            tbody.innerHTML = formationsList.map(f => `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-5 whitespace-nowrap">
                        <div class="flex items-center">
                            <img src="${f.image_url}" class="h-10 w-10 rounded-lg object-cover mr-4 border border-gray-200" alt="">
                            <div>
                                <div class="text-sm font-bold text-gray-900">${f.name_fr}</div>
                                <div class="text-sm text-gray-500 flex items-center mt-1"><svg class="w-3 h-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>${f.formateur}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-5 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900 flex items-center"><svg class="w-4 h-4 mr-1 text-brand-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>${f.date} à ${f.time}</div>
                        <div class="text-sm text-gray-500 mt-1 flex items-center"><svg class="w-4 h-4 mr-1 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/></svg>${f.location}</div>
                    </td>
                    <td class="px-6 py-5 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="exportInscriptions(${f.id}, '${f.name_fr.replace(/'/g, "\\'")}')" class="inline-flex items-center text-brand-700 hover:text-white font-bold bg-brand-50 hover:bg-brand-600 px-4 py-2 rounded-lg transition-colors border border-brand-100 hover:border-brand-600">
                            <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                            Exporter CSV
                        </button>
                    </td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>
